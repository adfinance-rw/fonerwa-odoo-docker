<odoo>
    <record id="view_approval_request_view_inherit_form" model="ir.ui.view">
      <field name="name">approval.request.view.inherit.form</field>
      <field name="model">approval.request</field>
      <field name="inherit_id" ref="approvals.approval_request_view_form"/>
      <field name="arch" type="xml">
        <xpath expr="//header/widget[@name='attach_document']" position="replace">
            <button name="action_confirm" string="Submit" type="object" class="btn-primary" invisible="not approver_ids or request_status != 'new'" data-hotkey="q"/>
        </xpath>
        <xpath expr="//header/button[@name='action_confirm']" position="attributes">
            <attribute name="invisible">1</attribute>
        </xpath>
        <xpath expr="//group[@name='request_main']" position="inside">
            <field name="category_type" invisible="1"/>
            <field name="purchase_request_number" 
                   invisible="category_type != 'invoice_payment'"
                   context="{'search_default_approved': 1, 'search_default_purchase_orders': 1}"
                   options="{'no_create': True}"
                   domain="[('category_type', '=', 'purchase_order'), ('request_status', '=', 'approved')]"/>
            <field name="invoice_payment_type" invisible="category_type != 'invoice_payment'"/>
            <field name="other_payment_type" invisible="category_type != 'other_payment'"/>
            <field name="purchase_type" invisible="category_type != 'purchase_order'"/>
            <field name="po_exceeds_10m" invisible="category_type != 'purchase_order'"/>
            <field name="po_exceeds_20m" invisible="category_type != 'purchase_order' or not po_exceeds_10m"/>
        </xpath>
        
        <!-- Make reference field readonly since it's auto-generated -->
        <xpath expr="//field[@name='reference']" position="attributes">
            <attribute name="readonly">1</attribute>
        </xpath>

        <xpath expr="//notebook/page[@name='approvers']" position="before">
            <page string="Supporting Documents" name="payment_checklist" invisible="category_type not in ('invoice_payment', 'other_payment', 'purchase_order')">
                <field name="checklist_line_ids" nolabel="1" context="{'list_view_ref': 'approval_module.approval_checklist_line_view_list', 'form_view_ref': 'approval_module.approval_checklist_line_view_form'}" options="{'no_create_edit': True, 'no_open': True}"/>
            </page>
        </xpath>
        
        <!-- Enhance the Approver(s) tab to show roles -->
        <xpath expr="//page[@name='approvers']" position="replace">
            <page string="Approver(s)" name="approvers" groups="approvals.group_approval_manager">
              <field name="approver_ids" mode="list,kanban" readonly="request_status != 'new'">
                  <list editable="bottom" decoration-success="status=='approved'" decoration-warning="status in ['pending', 'waiting']" decoration-danger="status=='refused'" no_open="1">
                      <field name="existing_request_user_ids" column_invisible="True"/>
                      <field name="sequence" column_invisible="True"/>
                      <field name="can_edit" column_invisible="True"/>
                      <field name="can_edit_user_id" column_invisible="True"/>
                      <field name="user_id" string="Approver" readonly="not can_edit_user_id or status != 'new'" force_save="1" />
                      <field name="required" readonly="not can_edit" force_save="1"/>
                      <field name="status"/>
                      <field name="company_id" column_invisible="True"/>
                      <field name="approval_role" string="Role" optional="show"/>
                  </list>
                  <kanban class="o_kanban_mobile">
                      <templates>
                          <t t-name="card" class="flex-row">
                              <field name="user_id"/>
                              <t t-if="record.status.raw_value">
                                  <t t-set="classname" t-value="{'approved': 'text-bg-success', 'pending': 'text-bg-warning', 'refused': 'text-bg-danger'}[record.status.raw_value] || 'text-bg-light'"/>
                                  <span t-attf-class="ms-auto rounded-pill {{ classname }}">
                                      <field name="status"/>
                                  </span>
                              </t>
                          </t>
                      </templates>
                  </kanban>
                  <form>
                      <group>
                          <field name="company_id" invisible="1"/>
                          <field name="existing_request_user_ids" invisible="1"/>
                          <field name="user_id"/>
                      </group>
                  </form>
              </field>
          </page>
        </xpath>
      </field>
    </record>

    <record id="approval_checklist_line_view_list" model="ir.ui.view">
      <field name="name">approval.checklist.line.view.list</field>
      <field name="model">approval.checklist.line</field>
      <field name="arch" type="xml">
        <list editable="bottom">
          <field name="name" readonly="1"/>
          <field name="is_required" readonly="1"/>
          <field name="document_ids" widget="many2many_binary"/>
        </list>
      </field>
    </record>

    <record id="approval_checklist_line_view_form" model="ir.ui.view">
      <field name="name">approval.checklist.line.view.form</field>
      <field name="model">approval.checklist.line</field>
      <field name="arch" type="xml">
        <form>
          <group>
            <field name="name"/>
            <field name="is_required"/>
            <field name="document_ids" widget="many2many_binary"/>
          </group>
        </form>
      </field>
    </record>

    <!-- Custom search view for Purchase Request selection -->
    <record id="view_approval_request_purchase_search" model="ir.ui.view">
      <field name="name">approval.request.purchase.search</field>
      <field name="model">approval.request</field>
      <field name="arch" type="xml">
        <search>
          <field name="name" string="Subject"/>
          <field name="request_owner_id" string="Request Owner"/>
          <field name="date" string="Date"/>
          <field name="category_id" string="Category"/>
          <filter string="Approved" name="approved" domain="[('request_status', '=', 'approved')]"/>
          <filter string="Purchase Orders" name="purchase_orders" domain="[('category_type', '=', 'purchase_order')]"/>
          <group expand="0" string="Group By">
            <filter string="Status" name="group_status" context="{'group_by': 'request_status'}"/>
            <filter string="Request Owner" name="group_owner" context="{'group_by': 'request_owner_id'}"/>
            <filter string="Date" name="group_date" context="{'group_by': 'date'}"/>
          </group>
        </search>
      </field>
    </record>

    <!-- Custom list view for Purchase Request selection -->
    <record id="view_approval_request_purchase_list" model="ir.ui.view">
      <field name="name">approval.request.purchase.list</field>
      <field name="model">approval.request</field>
      <field name="arch" type="xml">
        <list>
          <field name="name" string="Subject"/>
          <field name="category_id" string="Category"/>
          <field name="request_owner_id" string="Request Owner"/>
          <field name="date" string="Date"/>
          <field name="request_status" string="Status"/>
          <field name="amount" string="Amount"/>
        </list>
      </field>
    </record>
</odoo>