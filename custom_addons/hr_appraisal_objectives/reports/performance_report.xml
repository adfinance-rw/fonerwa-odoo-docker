<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="performance_report">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="hr_appraisal_objectives.performance_report_document"/>
            </t>
        </t>
    </template>

    <template id="performance_report_document">
        <t t-call="web.external_layout">
            <div class="page">
                <!-- Report Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h1 class="text-center text-primary">
                            <i class="fa fa-chart-line me-2"></i>Performance Analytics Report
                        </h1>
                        <p class="text-center text-muted">
                            <strong>Report Type:</strong> <span t-esc="o.report_type.replace('_', ' ').title()"/> | 
                            <strong>Period:</strong> <span t-esc="o.date_from"/> to <span t-esc="o.date_to"/> |
                            <strong>Generated:</strong> <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%Y-%m-%d %H:%M')"/>
                        </p>
                    </div>
                </div>

                <!-- Executive Summary -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h3 class="card-title mb-0">
                                    <i class="fa fa-tachometer-alt me-2"></i>Executive Summary
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <div class="metric-box">
                                            <h4 class="text-primary">
                                                <t t-if="o.report_type == 'department'">
                                                    <span t-esc="len(o.departments) if o.departments else 0"/>
                                                </t>
                                                <t t-if="o.report_type == 'institutional'">
                                                    <span t-esc="len(o.institutional) if o.institutional else 0"/>
                                                </t>
                                                <t t-if="o.report_type == 'individual'">
                                                    <span t-esc="len(o.individuals) if o.individuals else 0"/>
                                                </t>
                                                <t t-if="o.report_type == 'comparative'">
                                                    <span t-esc="len(o.comparative) if o.comparative else 0"/>
                                                </t>
                                            </h4>
                                            <p class="text-muted">Total Units Analyzed</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="metric-box">
                                            <h4 class="text-success">
                                                <t t-if="o.report_type == 'department'">
                                                    <span t-esc="'%.1f' % (sum(d.get('avg_progress', 0) for d in o.departments) / len(o.departments) if o.departments else 0)"/>%
                                                </t>
                                                <t t-if="o.report_type == 'institutional'">
                                                    <span t-esc="'%.1f' % (sum(d.get('progress', 0) for d in o.institutional) / len(o.institutional) if o.institutional else 0)"/>%
                                                </t>
                                                <t t-if="o.report_type == 'individual'">
                                                    <span t-esc="'%.1f' % (sum(d.get('avg_progress', 0) for d in o.individuals) / len(o.individuals) if o.individuals else 0)"/>%
                                                </t>
                                                <t t-if="o.report_type == 'comparative'">
                                                    <span t-esc="'%.1f' % (sum(d.get('avg_progress', 0) for d in o.comparative) / len(o.comparative) if o.comparative else 0)"/>%
                                                </t>
                                            </h4>
                                            <p class="text-muted">Average Progress</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="metric-box">
                                            <h4 class="text-info">
                                                <t t-if="o.report_type == 'department'">
                                                    <span t-esc="'%.1f' % (sum(d.get('avg_score', 0) for d in o.departments) / len(o.departments) if o.departments else 0)"/>
                                                </t>
                                                <t t-if="o.report_type == 'institutional'">
                                                    <span t-esc="'%.1f' % (sum(d.get('avg_score', 0) for d in o.institutional) / len(o.institutional) if o.institutional else 0)"/>
                                                </t>
                                                <t t-if="o.report_type == 'individual'">
                                                    <span t-esc="'%.1f' % (sum(d.get('avg_score', 0) for d in o.individuals) / len(o.individuals) if o.individuals else 0)"/>
                                                </t>
                                                <t t-if="o.report_type == 'comparative'">
                                                    <span t-esc="'%.1f' % (sum(d.get('avg_score', 0) for d in o.comparative) / len(o.comparative) if o.comparative else 0)"/>
                                                </t>
                                            </h4>
                                            <p class="text-muted">Average Score</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="metric-box">
                                            <h4 class="text-warning">
                                                <t t-if="o.report_type == 'department'">
                                                    <span t-esc="sum(d.get('completed_goals', 0) for d in o.departments) if o.departments else 0"/>
                                                </t>
                                                <t t-if="o.report_type == 'individual'">
                                                    <span t-esc="sum(d.get('completed_goals', 0) for d in o.individuals) if o.individuals else 0"/>
                                                </t>
                                                <t t-if="o.report_type in ['institutional', 'comparative']">
                                                    <span t-esc="0"/>
                                                </t>
                                            </h4>
                                            <p class="text-muted">Completed Goals</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Department Performance Report -->
                <t t-if="o.report_type == 'department' and o.departments">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h3 class="card-title mb-0">
                                        <i class="fa fa-building me-2"></i>Department Performance Analysis
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Department</th>
                                                    <th>Objectives</th>
                                                    <th>Goals</th>
                                                    <th>Avg Progress</th>
                                                    <th>Avg Score</th>
                                                    <th>Completed</th>
                                                    <th>Performance</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="o.departments" t-as="dept">
                                                    <tr>
                                                        <td><strong><span t-esc="dept.get('department', {}).name if dept.get('department') else ''"/></strong></td>
                                                        <td><span t-esc="dept.get('objectives_count', 0)"/></td>
                                                        <td><span t-esc="dept.get('goals_count', 0)"/></td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar" role="progressbar" 
                                                                     t-att-style="'width: ' + str(dept.get('avg_progress', 0)) + '%;'"
                                                                     t-att-aria-valuenow="dept.get('avg_progress', 0)" 
                                                                     aria-valuemin="0" aria-valuemax="100">
                                                                    <span t-esc="'%.1f' % dept.get('avg_progress', 0)"/>%
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span t-att-class="'badge ' + ('badge-success' if dept.get('avg_score', 0) >= 4 else 'badge-warning' if dept.get('avg_score', 0) >= 3 else 'badge-danger')">
                                                                <span t-esc="'%.1f' % dept.get('avg_score', 0)"/>
                                                            </span>
                                                        </td>
                                                        <td><span t-esc="dept.get('completed_goals', 0)"/></td>
                                                        <td>
                                                            <t t-if="dept.get('avg_score', 0) >= 4">
                                                                <span class="badge badge-success">Excellent</span>
                                                            </t>
                                                            <t t-elif="dept.get('avg_score', 0) >= 3">
                                                                <span class="badge badge-warning">Good</span>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="badge badge-danger">Needs Improvement</span>
                                                            </t>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>

                <!-- Institutional Performance Report -->
                <t t-if="o.report_type == 'institutional' and o.institutional">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h3 class="card-title mb-0">
                                        <i class="fa fa-globe me-2"></i>Institutional Objectives Analysis
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Objective</th>
                                                    <th>Progress</th>
                                                    <th>Departments</th>
                                                    <th>Individuals</th>
                                                    <th>Avg Score</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="o.institutional" t-as="inst">
                                                    <tr>
                                                        <td><strong><span t-esc="inst.get('objective', {}).name if inst.get('objective') else ''"/></strong></td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar" role="progressbar" 
                                                                     t-att-style="'width: ' + str(inst.get('progress', 0)) + '%;'"
                                                                     t-att-aria-valuenow="inst.get('progress', 0)" 
                                                                     aria-valuemin="0" aria-valuemax="100">
                                                                    <span t-esc="'%.1f' % inst.get('progress', 0)"/>%
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td><span t-esc="inst.get('departments_count', 0)"/></td>
                                                        <td><span t-esc="inst.get('total_individuals', 0)"/></td>
                                                        <td>
                                                            <span t-att-class="'badge ' + ('badge-success' if inst.get('avg_score', 0) >= 4 else 'badge-warning' if inst.get('avg_score', 0) >= 3 else 'badge-danger')">
                                                                <span t-esc="'%.1f' % inst.get('avg_score', 0)"/>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <t t-if="inst.get('progress', 0) >= 100">
                                                                <span class="badge badge-success">Completed</span>
                                                            </t>
                                                            <t t-elif="inst.get('progress', 0) >= 70">
                                                                <span class="badge badge-info">On Track</span>
                                                            </t>
                                                            <t t-elif="inst.get('progress', 0) >= 30">
                                                                <span class="badge badge-warning">In Progress</span>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="badge badge-danger">At Risk</span>
                                                            </t>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>

                <!-- Individual Performance Report -->
                <t t-if="o.report_type == 'individual' and o.individuals">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-warning text-dark">
                                    <h3 class="card-title mb-0">
                                        <i class="fa fa-user me-2"></i>Individual Performance Analysis
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Employee</th>
                                                    <th>Department</th>
                                                    <th>Goals</th>
                                                    <th>Avg Progress</th>
                                                    <th>Avg Score</th>
                                                    <th>Completed</th>
                                                    <th>Performance</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="o.individuals" t-as="ind">
                                                    <tr>
                                                        <td><strong><span t-esc="ind.get('employee', {}).name if ind.get('employee') else ''"/></strong></td>
                                                        <td><span t-esc="ind.get('employee', {}).department_id.name if ind.get('employee') and ind.get('employee').department_id else ''"/></td>
                                                        <td><span t-esc="ind.get('goals_count', 0)"/></td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar" role="progressbar" 
                                                                     t-att-style="'width: ' + str(ind.get('avg_progress', 0)) + '%;'"
                                                                     t-att-aria-valuenow="ind.get('avg_progress', 0)" 
                                                                     aria-valuemin="0" aria-valuemax="100">
                                                                    <span t-esc="'%.1f' % ind.get('avg_progress', 0)"/>%
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span t-att-class="'badge ' + ('badge-success' if ind.get('avg_score', 0) >= 4 else 'badge-warning' if ind.get('avg_score', 0) >= 3 else 'badge-danger')">
                                                                <span t-esc="'%.1f' % ind.get('avg_score', 0)"/>
                                                            </span>
                                                        </td>
                                                        <td><span t-esc="ind.get('completed_goals', 0)"/></td>
                                                        <td>
                                                            <t t-if="ind.get('avg_score', 0) >= 4">
                                                                <span class="badge badge-success">Top Performer</span>
                                                            </t>
                                                            <t t-elif="ind.get('avg_score', 0) >= 3">
                                                                <span class="badge badge-warning">Good</span>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="badge badge-danger">Needs Support</span>
                                                            </t>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>

                <!-- Comparative Analysis Report -->
                <t t-if="o.report_type == 'comparative' and o.comparative">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-danger text-white">
                                    <h3 class="card-title mb-0">
                                        <i class="fa fa-balance-scale me-2"></i>Comparative Analysis
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Department</th>
                                                    <th>Total Goals</th>
                                                    <th>Avg Score</th>
                                                    <th>Completion Rate</th>
                                                    <th>Avg Progress</th>
                                                    <th>Rank</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="o.comparative" t-as="comp">
                                                    <tr>
                                                        <td><strong><span t-esc="comp.get('department', '')"/></strong></td>
                                                        <td><span t-esc="comp.get('total_goals', 0)"/></td>
                                                        <td>
                                                            <span t-att-class="'badge ' + ('badge-success' if comp.get('avg_score', 0) &gt;= 4 else 'badge-warning' if comp.get('avg_score', 0) &gt;= 3 else 'badge-danger')">
                                                                <span t-esc="'%.1f' % comp.get('avg_score', 0)"/>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar" role="progressbar" 
                                                                     t-att-style="'width: ' + str(comp.get('completion_rate', 0) * 100) + '%;'"
                                                                     t-att-aria-valuenow="comp.get('completion_rate', 0) * 100" 
                                                                     aria-valuemin="0" aria-valuemax="100">
                                                                    <span t-esc="'%.1f' % (comp.get('completion_rate', 0) * 100)"/>%
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar" role="progressbar" 
                                                                     t-att-style="'width: ' + str(comp.get('avg_progress', 0)) + '%;'"
                                                                     t-att-aria-valuenow="comp.get('avg_progress', 0)" 
                                                                     aria-valuemin="0" aria-valuemax="100">
                                                                    <span t-esc="'%.1f' % comp.get('avg_progress', 0)"/>%
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span t-att-class="'badge ' + ('badge-success' if loop.index &lt;= 3 else 'badge-warning' if loop.index &lt;= 6 else 'badge-danger')">
                                                                #<span t-esc="loop.index"/>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>

                <!-- Recommendations Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h3 class="card-title mb-0">
                                    <i class="fa fa-lightbulb me-2"></i>Key Insights &amp; Recommendations
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5><i class="fa fa-chart-line text-primary me-2"></i>Performance Trends</h5>
                                        <ul class="list-unstyled">
                                            <li><i class="fa fa-arrow-up text-success me-2"></i>Overall progress shows positive momentum</li>
                                            <li><i class="fa fa-star text-warning me-2"></i>Average scores indicate room for improvement</li>
                                            <li><i class="fa fa-clock text-info me-2"></i>Timeline adherence needs attention</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h5><i class="fa fa-tasks text-success me-2"></i>Action Items</h5>
                                        <ul class="list-unstyled">
                                            <li><i class="fa fa-check-circle text-primary me-2"></i>Focus on underperforming departments</li>
                                            <li><i class="fa fa-users text-info me-2"></i>Provide additional training where needed</li>
                                            <li><i class="fa fa-calendar text-warning me-2"></i>Review and adjust timelines</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="row">
                    <div class="col-12 text-center">
                        <hr/>
                        <p class="text-muted">
                            <small>
                                This report was generated automatically by the HR Appraisal Objectives system.<br/>
                                For questions or support, please contact your HR department.
                            </small>
                        </p>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Report Action -->
    <record id="action_performance_report" model="ir.actions.report">
        <field name="name">Performance Report</field>
        <field name="model">performance.report.wizard</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">hr_appraisal_objectives.performance_report</field>
        <field name="report_file">hr_appraisal_objectives.performance_report</field>
        <field name="print_report_name">'Performance Report - %s' % (object.report_type.replace('_', ' ').title())</field>
        <field name="binding_model_id" ref="model_performance_report_wizard"/>
        <field name="binding_type">report</field>
    </record>
</odoo>
