<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Add RFQ Pricing menu to portal home -->
    <template id="portal_my_home_rfq_pricing" name="RFQ Pricing Portal Menu" 
              inherit_id="portal.portal_my_home" customize_show="True" priority="30">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
            <t t-set="portal_vendor_category_enable" t-value="True"/>
        </xpath>
        <div id="portal_vendor_category" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'fa-shopping-cart'"/>
                <t t-set="title">RFQ Pricing</t>
                <t t-set="url" t-value="'/my/rfq/pricing'"/>
                <t t-set="text">Submit your quotes</t>
                <t t-set="placeholder_count" t-value="'rfq_pricing_count'"/>
            </t>
        </div>
    </template>

    <!-- RFQ Pricing List View -->
    <template id="portal_my_rfq_pricing" name="My RFQ Pricing">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <t t-call="portal.portal_searchbar">
                <t t-set="title">RFQ Pricing</t>
            </t>
            
            <t t-if="not rfqs">
                <div class="alert alert-info" role="alert">
                    <p>There are currently no RFQs requiring your pricing.</p>
                    <p>You will receive an email notification when new RFQs are sent to you.</p>
                </div>
            </t>
            
            <t t-if="rfqs" t-call="portal.portal_table">
                <thead>
                    <tr class="active">
                        <th class="text-left">RFQ #</th>
                        <th class="text-center">Order Date</th>
                        <th class="text-center">Company</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Total Lines</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <t t-foreach="rfqs" t-as="order">
                        <tr>
                            <td class="text-left">
                                <a t-attf-href="/my/purchase/{{order.id}}?{{keep_query()}}">
                                    <t t-esc="order.name"/>
                                </a>
                            </td>
                            <td class="text-center">
                                <span t-field="order.date_order" t-options='{"widget": "date"}'/>
                            </td>
                            <td class="text-center">
                                <span t-field="order.company_id.name"/>
                            </td>
                            <td class="text-center">
                                <span t-field="order.state" class="badge badge-pill badge-info"/>
                            </td>
                            <td class="text-center">
                                <span t-esc="len(order.order_line)"/>
                            </td>
                            <td class="text-end">
                                <a t-attf-href="/my/purchase/{{order.id}}/pricing?{{keep_query()}}" 
                                   class="btn btn-primary btn-sm">
                                    <i class="fa fa-edit"/> Submit Pricing
                                </a>
                            </td>
                        </tr>
                    </t>
                </tbody>
            </t>
        </t>
    </template>

    <!-- RFQ Pricing Form -->
    <template id="portal_rfq_pricing_form" name="RFQ Pricing Form">
        <t t-call="portal.portal_layout">
            <t t-set="o_portal_fullwidth_alert" t-value="True"/>
            
            <!-- Breadcrumbs -->
            <div class="row">
                <div class="col-12">
                    <ol class="o_portal_submenu breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="/my/purchase">Purchase Orders</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a t-attf-href="/my/purchase/{{order.id}}?{{keep_query()}}">
                                <t t-esc="order.name"/>
                            </a>
                        </li>
                        <li class="breadcrumb-item active">
                            Pricing
                        </li>
                    </ol>
                </div>
            </div>

            <!-- Header -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">
                                <i class="fa fa-shopping-cart"/> Submit Your Pricing for RFQ: <t t-esc="order.name"/>
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Company:</strong> <span t-field="order.company_id.name"/><br/>
                                    <strong>Order Date:</strong> <span t-field="order.date_order" t-options='{"widget": "date"}'/><br/>
                                    <strong>Expected Date:</strong> <span t-field="order.date_planned" t-options='{"widget": "date"}'/><br/>
                                </div>
                                <div class="col-md-6">
                                    <strong>Currency:</strong> <span t-field="order.currency_id.name"/><br/>
                                    <strong>Status:</strong> <span t-field="order.state" class="badge badge-info"/><br/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pricing Form -->
            <div class="row mt-4">
                <div class="col-12">
                    <form method="post" t-attf-action="/my/purchase/{{order.id}}/pricing/submit?{{keep_query()}}" 
                          class="o_portal_rfq_pricing_form">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fa fa-list"/> Product Lines - Please Enter Your Prices
                                </h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover mb-0">
                                        <thead class="thead-light">
                                            <tr>
                                                <th class="text-left">Product</th>
                                                <th class="text-center">Description</th>
                                                <th class="text-center">Quantity</th>
                                                <th class="text-center">UoM</th>
                                                <th class="text-center">Current Price</th>
                                                <th class="text-center" style="background-color: #e3f2fd;">
                                                    <strong>Your Price *</strong>
                                                </th>
                                                <th class="text-end">Subtotal</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="order.order_line" t-as="line">
                                                <tr>
                                                    <td class="text-left">
                                                        <strong t-field="line.product_id.name"/>
                                                        <t t-if="line.product_id.default_code">
                                                            <br/><small class="text-muted">[<span t-field="line.product_id.default_code"/>]</small>
                                                        </t>
                                                    </td>
                                                    <td class="text-center">
                                                        <span t-field="line.name"/>
                                                    </td>
                                                    <td class="text-center">
                                                        <span t-field="line.product_qty"/>
                                                    </td>
                                                    <td class="text-center">
                                                        <span t-field="line.product_uom.name"/>
                                                    </td>
                                                    <td class="text-center">
                                                        <t t-if="line.price_unit">
                                                            <span t-esc="'{:,.2f}'.format(line.price_unit)"/> 
                                                            <span t-field="order.currency_id.symbol"/>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="text-muted">Not set</span>
                                                        </t>
                                                    </td>
                                                    <td class="text-center" style="background-color: #f8f9fa;">
                                                        <div class="input-group input-group-sm">
                                                            <input type="number" 
                                                                   t-attf-name="supplier_price_{{line.id}}" 
                                                                   t-attf-id="supplier_price_{{line.id}}"
                                                                   class="form-control supplier-price-input" 
                                                                   step="0.01" 
                                                                   min="0"
                                                                   placeholder="0.00"
                                                                   t-att-value="line.x_supplier_price if line.x_supplier_price else ''"
                                                                   t-att-data-line-id="line.id"
                                                                   t-att-data-quantity="line.product_qty"
                                                                   style="text-align: right;"/>
                                                            <div class="input-group-append">
                                                                <span class="input-group-text" t-esc="order.currency_id.symbol"/>
                                                            </div>
                                                        </div>
                                                        <t t-if="line.supplier_price_submitted">
                                                            <small class="text-success">
                                                                <i class="fa fa-check"/> Submitted
                                                            </small>
                                                        </t>
                                                    </td>
                                                    <td class="text-end">
                                                        <span t-attf-id="subtotal_{{line.id}}" class="font-weight-bold">
                                                            <t t-if="line.x_supplier_price">
                                                                <span t-esc="'{:,.2f}'.format(line.x_supplier_price * line.product_qty)"/>
                                                                <span t-field="order.currency_id.symbol"/>
                                                            </t>
                                                            <t t-else="">
                                                                0.00 <span t-field="order.currency_id.symbol"/>
                                                            </t>
                                                        </span>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                        <tfoot class="thead-light">
                                            <tr>
                                                <td colspan="6" class="text-end"><strong>Total Quoted Amount:</strong></td>
                                                <td class="text-end">
                                                    <strong>
                                                        <span id="total_amount">
                                                            <t t-set="total" t-value="sum(line.x_supplier_price * line.product_qty for line in order.order_line if line.x_supplier_price)"/>
                                                            <span t-esc="'{:,.2f}'.format(total)"/>
                                                        </span>
                                                        <span t-field="order.currency_id.symbol"/>
                                                    </strong>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Instructions and Submit -->
                        <div class="row mt-4">
                            <div class="col-md-8">
                                <div class="alert alert-info">
                                    <h6><i class="fa fa-info-circle"/> Instructions:</h6>
                                    <ul class="mb-0">
                                        <li>Please enter your unit price for each product line</li>
                                        <li>Prices should be in <strong t-esc="order.currency_id.name"/></li>
                                        <li>You can save your progress and come back later</li>
                                        <li>Once submitted, the purchasing team will be notified</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-end">
                                    <a t-attf-href="/my/purchase/{{order.id}}?{{keep_query()}}" 
                                       class="btn btn-light me-2">
                                        <i class="fa fa-arrow-left"/> Back to RFQ
                                    </a>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fa fa-paper-plane"/> Submit Pricing
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Vendor Prices Already Submitted Notice -->
            <t t-if="order.vendor_prices_submitted">
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-success">
                            <h6><i class="fa fa-check-circle"/> Prices Already Submitted</h6>
                            <p class="mb-0">
                                You have already submitted pricing for this RFQ on 
                                <strong t-field="order.vendor_submission_date" t-options='{"widget": "datetime"}'/>. 
                                You can still update your prices using the form above.
                            </p>
                        </div>
                    </div>
                </div>
            </t>
        </t>
    </template>



    <!-- Portal breadcrumbs for RFQ pricing -->
    <template id="portal_rfq_pricing_breadcrumbs" name="RFQ Pricing Breadcrumbs" 
              inherit_id="portal.portal_breadcrumbs" priority="30">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'rfq_pricing'" t-attf-class="breadcrumb-item #{'active ' if not order else ''}">
                <a t-if="order" t-attf-href="/my/rfq/pricing?{{keep_query()}}">RFQ Pricing</a>
                <t t-else="">RFQ Pricing</t>
            </li>
            <li t-if="page_name == 'rfq_pricing' and order" class="breadcrumb-item active">
                <t t-esc="order.name"/>
            </li>
        </xpath>
    </template>

    <!-- Extend Standard Purchase Order Portal View to Add Pricing Button -->
    <template id="portal_my_purchase_order_pricing_button" 
              inherit_id="purchase.portal_my_purchase_order" priority="20">
        <xpath expr="//div[hasclass('d-flex') and hasclass('gap-2')]" position="after">
            <!-- Vendor Pricing Buttons -->
            <t t-if="order.state in ['draft', 'sent']">
                <div class="mt-3">
                    <div class="border-top pt-3">
                        <h6 class="text-muted mb-2">
                            <i class="fa fa-calculator me-2"/>Pricing Submission
                        </h6>
                        <t t-if="not order.vendor_prices_submitted">
                            <a t-attf-href="/my/purchase/{{order.id}}/pricing?{{keep_query()}}" 
                               class="btn btn-success w-100 mb-2" 
                               style="border-radius: 6px; font-weight: 500;">
                                <i class="fa fa-pencil-square-o me-2"/>Submit Your Pricing
                            </a>
                            <small class="text-muted d-block text-center">
                                <i class="fa fa-info-circle me-1"/>Click to provide your pricing for each item
                            </small>
                        </t>
                        <t t-if="order.vendor_prices_submitted">
                            <a t-attf-href="/my/purchase/{{order.id}}/pricing?{{keep_query()}}" 
                               class="btn btn-outline-primary w-100 mb-2" 
                               style="border-radius: 6px; font-weight: 500;">
                                <i class="fa fa-edit me-2"/>Update Pricing
                            </a>
                            <small class="text-success d-block text-center">
                                <i class="fa fa-check-circle me-1"/>Pricing submitted - click to make changes
                            </small>
                        </t>
                    </div>
                </div>
            </t>
        </xpath>
    </template>

</odoo> 